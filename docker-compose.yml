version: '3.8'

services:
  training:
    build:
      context: .
      dockerfile: Dockerfile.training
    image: meanflow-training:latest
    container_name: meanflow-training

    # GPU support
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['4', '5', '6', '7']
              capabilities: [gpu]

    # Volumes for persistence
    volumes:
      - ./logs:/workspace/logs
      - ./models:/workspace/models
      - ./images:/workspace/images
      - ./runs:/workspace/runs
      - ./data:/workspace/data
      - ./mnist:/workspace/mnist
      - ./cifar:/workspace/cifar
      - ./.venv:/workspace/.venv

    # Port mapping for TensorBoard
    ports:
      - "6006:6006"

    # Restart policy
    restart: unless-stopped

    # Keep container running
    tty: true
    stdin_open: true
